@Html.Partial("MapPartial")
<link rel="stylesheet" href="~/Content/prj/sub/floodquery.css" />
<link rel="stylesheet" href="~/Content/prj/rthydro.css" />

@Html.Partial("_ArcgisMapPartial")
@Html.Partial("_ArcgisQpesums")

<script>
    const MAP_SERVER = 'https://water.tainan.gov.tw/tnwrbarcgis104/rest/services/TNRW/IISI_rainwater/MapServer';
    const LAYER_ID = "PIPE_LAYER";
    const LAYER_ID2 = "STATION_LAYER";
    function switch_rain_data() {
      const h = $("#select_rain_data").val() * 1;
      switch (h) {
        case 0:
            qpesum_last_60m();
            return;
        default:
            csv_data(h);
            break;
      }
    }
    function csv_data(h) {
       const list_url = `${app.siteRoot}api/model/input/grid_rain/list`;
       $.get(list_url).then(response => {
          if (response && response[0]) {
            $("#loading").show();
            const t0 = response[0].split(',')[0];
            manysplendid_csv_data(t0, h);
          } else {
            alert("無預報雨量資料！");
          }
       });
    }
    function add_station_layer() {
        if (!arcgis_map.ready) {
            setTimeout(add_station_layer, 1000);
            return;
        }
        $.post('@Url.Action("Stations")').then(response => {
            const old_layer = arcgis_map.map.findLayerById(LAYER_ID2);
            if (old_layer) {
                arcgis_map.map.remove(old_layer);
            }
            const renderer = {
                type: "simple",
                symbol: {
                    type: "picture-marker",  // autocasts as new PictureMarkerSymbol()
                    url: '@Url.Content("~/images/pin/下水道_正常.png")',
                    width: "32px",
                    height: "32px"
                }
            };
            const list = [];
            let ptr = 0;
            for (var row of response) {
                const lon = row.lon * 1.0;
                const lat = row.lat * 1.0;
                ptr++;
                list.push({
                    geometry: {
                        type: "point",
                        x: lon,
                        y: lat,
                    },
                    attributes: {
                        OBJECTID: ptr,
                        name: row.stt_name,
                        addr: row.addr,
                        lon,
                        lat
                    }
                });
            }
            const layer = arcgis_map.createFeatureLayer({
                id: LAYER_ID2,
                source: list,  // array of graphics objects
                objectIdField: "OBJECTID",
                fields: [{
                    name: "OBJECTID",
                    type: "oid"
                }, {
                    name: "name",
                    type: "string"
                }, {
                    name: "addr",
                    type: "string"
                }, {
                    name: "lat",
                    type: "double"
                },
                {
                    name: "lon",
                    type: "double"
                }],
                popupTemplate: {
                    overwriteActions: true,
                    title: "雨水下水道監測站",
                    content: "站名: {name}<br/>座標: {lon},{lat}<br/>地址: {addr}"
                },
                renderer,
                opacity: 1,
            });
            arcgis_map.map.add(layer);
        });
    }
    function add_pipe_layer() {
        if (!arcgis_map.ready)
        {
            setTimeout(add_pipe_layer, 1000);
            return;
        }
        const old_layer = arcgis_map.map.findLayerById(LAYER_ID);
        if (old_layer) {
            arcgis_map.map.remove(old_layer);
        }

        const mapserver_layer = arcgis_map.createMapImageLayer({
            id: LAYER_ID,
            url: MAP_SERVER,
            sublayers: [
                {
                    id: 4,
                    visible: true
                },
                {
                    id: 3,
                    visible: true
                },
                {
                    id: 2,
                    visible: true
                },
                {
                    id: 1,
                    visible: true
                },
                {
                    id: 0,
                    visible: true
                }
            ]
        });
        arcgis_map.map.add(mapserver_layer, 2);
        $.get(MAP_SERVER + '/legend').then(html => {
            const dom = $.parseHTML(html);
            const div = dom.find(x => x.tagName == 'DIV' && x.className == 'rbody');
            const to_remove = $(div).find(`td:contains("all other values")`).parents("tr");
            let legend_html = div.outerHTML;
            if (to_remove && to_remove[0]) {
                legend_html = legend_html.replace(to_remove[0].outerHTML, "");
            }
            $("#arcgis_legend").html(
                `<h5><input type="checkbox" checked onclick="toggle_pipe()" />顯示下水道管道</h5>` +
                legend_html
            );
        });
    }

    function toggle_pipe(show) {
        const old_layer = arcgis_map.map.findLayerById(LAYER_ID);
        if (!old_layer) return;
        if (show === true) {
            old_layer.visible = true;
        } else if (show === false) {
            old_layer.visible = false;
        } else {
            old_layer.visible = !old_layer.visible;
        }

    }

    $(document).ready(function () {
        add_pipe_layer();
        add_station_layer();
        qpesum_forecast_60m();
    });
</script>
<div style="position: absolute; top: 70px; left: 30px; height: calc(100vh - 260px); display: flex; flex-direction: column; flex-wrap: wrap;">
    <div id="arcgis_legend" style="width: 300px; height: 535px; margin-bottom: -20px; overflow-y: hidden; transform: scale(0.9); transform-origin: top left; background: rgba(255,255,255,0.85); border-radius: 20px; padding: 15px;">        
    </div>
    <div style="width: 270px; height: 140px; background: rgba(255,255,255,0.85); border-radius: 20px; padding: 15px;">
        <h5><input type="checkbox" checked onclick="qpesums.toggle_qpesums()"/>雨量資料類型：</h5>
        <select id="select_rain_data" style="color: rgb(14 8 100); font-weight: 800;" onchange="switch_rain_data()">
            <option value="0">QPESUMS一小時觀測雨量</option>
            <option selected value="1">QPESUMS第一小時累積雨量</option>
            <option value="2">QPESUMS第二小時累積雨量</option>
            <option value="3">QPESUMS第三小時累積雨量</option>
            <option value="4">WRF第四小時累積雨量</option>
            <option value="5">WRF第五小時累積雨量</option>
            <option value="6">WRF第六小時累積雨量</option>
            <option value="7">WRF第七小時累積雨量</option>
            <option value="8">WRF第八小時累積雨量</option>
            <option value="9">WRF第九小時累積雨量</option>
            <option value="10">WRF第10小時累積雨量</option>
            <option value="11">WRF第11小時累積雨量</option>
            <option value="12">WRF第12小時累積雨量</option>
        </select>
        <h5>雨量資料時間：</h5>
        <h6 id="qpesum-datetime" style="color: rgb(14 8 100); font-weight: 800;"></h6>
    </div>
</div>